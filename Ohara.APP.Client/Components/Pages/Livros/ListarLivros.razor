@page "/livros"
@using Ohara.API.Shared.Responses
@using Ohara.APP.Client.Services
@inject LivroService LivroService
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject NavigationManager Nav

<div class="adventure-container">
    <div class="header-area">
        <h2 class="page-title">Tesouros Literários</h2>

        <div class="controls-row">
            <input @bind="filtro" @bind:event="oninput" placeholder="Buscar título..." class="search-ohara" />
            <button class="btn-novo" @onclick="CadastrarLivro">Catalogar Novo +</button>
        </div>
    </div>

    @if (carregando)
    {
        <div class="loading-msg">Decifrando os Poneglyphs...</div>
    }
    else if (!string.IsNullOrEmpty(erro))
    {
        <div class="error-msg">⚠️ @erro</div>
    }
    else
    {
        <div class="wanted-grid">
            @foreach (var livro in LivrosFiltrados)
            {
                <div class="wanted-card">
                    <div class="thumbtack tack-left"></div>
                    <div class="thumbtack tack-right"></div>

                    <div class="wanted-header-text">WANTED BOOK</div>

                    <div class="book-cover-frame">
                        <div class="book-icon">📖</div>
                    </div>

                    <div class="book-info">
                        <div class="book-title">@livro.Titulo</div>
                        <div class="book-genre">@livro.Genero</div>
                        <div class="book-desc">
                            @(string.IsNullOrEmpty(livro.Descricao) ? "Sem registros antigos..." : livro.Descricao)
                        </div>

                        <div class="actions">
                            <button class="btn-action btn-edit" @onclick="() => EditarLivro(livro.Id)">
                                ⚓ Editar
                            </button>
                            <button class="btn-action btn-delete" @onclick="() => ExcluirLivro(livro.Id)">
                                ✖ Queimar
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
        <button class="back-scroll" @onclick="Voltar">
            ← Voltar ao Mapa
        </button>
    }
</div>

@code {
    private List<LivroResponse> livros = new();
    private bool carregando = true;
    private string erro = string.Empty;
    private string filtro = string.Empty;

    private IEnumerable<LivroResponse> LivrosFiltrados =>
        livros.Where(l => string.IsNullOrWhiteSpace(filtro) ||
                          l.Titulo.Contains(filtro, StringComparison.OrdinalIgnoreCase))
              .ToList();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            livros = await LivroService.ObterTodos();
        }
        catch (Exception ex)
        {
            erro = $"Tempestade ao carregar: {ex.Message}";
        }
        finally
        {
            carregando = false;
        }
    }

    private void CadastrarLivro() => Navigation.NavigateTo("/livros/novo");
    private void EditarLivro(Guid id) => Navigation.NavigateTo($"/livros/editar/{id}");

    private async Task ExcluirLivro(Guid id)
    {
        var confirmado = await JS.InvokeAsync<bool>("confirm", "Este conhecimento será perdido para sempre. Deseja realmente queimar este livro?");
        if (!confirmado) return;

        var sucesso = await LivroService.Deletar(id);
        if (sucesso) livros = livros.Where(l => l.Id != id).ToList();
        else erro = "A Marinha impediu a destruição deste livro.";
    }

    private void Voltar() => Nav.NavigateTo("/");
}
